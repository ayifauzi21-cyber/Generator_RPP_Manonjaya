<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generator RPP Deep Learning - 8-3-3-4 Professional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [
            ["$", "$"],
            ["\\(", "\\)"],
          ],
          displayMath: [["$$", "$$"]],
        },
        svg: { fontCache: "global" },
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap");
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background-color: #f1f5f9;
      }
      .glass-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
      }
      .input-label {
        display: block;
        font-size: 0.7rem;
        font-weight: 800;
        color: #64748b;
        text-transform: uppercase;
        margin-bottom: 4px;
      }
      .custom-input {
        width: 100%;
        padding: 10px 14px;
        border: 1.5px solid #e2e8f0;
        border-radius: 10px;
        font-size: 0.9rem;
        transition: all 0.2s;
      }
      .custom-input:focus {
        border-color: #2563eb;
        outline: none;
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
      }
      .p3-checkbox {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        border: 1.5px solid #e2e8f0;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.85rem;
      }
      .p3-checkbox.active {
        border-color: #2563eb;
        background-color: #eff6ff;
      }
      #rppOutput {
        background: white;
        color: black;
        line-height: 1.5;
        font-size: 11pt;
        font-family: Arial, sans-serif;
        width: 100%;
        box-sizing: border-box;
      }
      #rppOutput table {
        width: 100% !important;
        border-collapse: collapse !important;
        border-spacing: 0 !important;
        margin-bottom: 15px;
        table-layout: auto;
        border: 1px solid black !important;
      }
      #rppOutput th,
      #rppOutput td {
        border: 1px solid black !important;
        padding: 8px 12px;
        vertical-align: top;
        word-wrap: break-word;
        box-sizing: border-box;
      }
      .section-bg {
        background-color: #f2f2f2;
        font-weight: bold;
      }
      .sig-container {
        width: 100%;
        margin-top: 20px;
        margin-bottom: 20px;
        page-break-inside: avoid;
      }
      .sig-table {
        width: 100% !important;
        border: none !important;
      }
      .sig-table td {
        border: none !important;
        text-align: center !important;
        width: 50%;
        padding: 5px !important;
      }
      .page-divider {
        page-break-before: always;
        border-top: 2px dashed #ccc;
        margin: 40px 0;
        text-align: center;
        position: relative;
      }
      .page-divider::after {
        content: "LAMPIRAN LKPD";
        position: absolute;
        top: -12px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 0 15px;
        font-weight: bold;
        color: #666;
        font-size: 10pt;
      }
      @media print {
        .no-print {
          display: none !important;
        }
        .page-divider {
          border: none !important;
          margin: 0 !important;
        }
        .page-divider::after {
          display: none !important;
        }
        body {
          background: white;
          padding: 0;
        }
        #rppOutput {
          padding: 0 !important;
          border: none !important;
        }
        @page {
          margin: 1.5cm;
        }
      }
    </style>
  </head>
  <body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
      <div class="mb-8 no-print flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-extrabold text-slate-900">Generator Modul Ajar <span class="text-blue-600">8-3-3-4 Smart</span></h1>
          <p class="text-slate-500 text-sm italic">Simpel, Cepat, Fleksibel, & Sesuai Standar Supervisi</p>
        </div>
        <div class="flex gap-2">
          <span class="bg-blue-100 text-blue-700 text-xs font-bold px-3 py-1 rounded-full border border-blue-200">DEEP LEARNING</span>
        </div>
      </div>

      <div id="inputForm" class="space-y-6 no-print">
        <div class="glass-card p-6 border-l-4 border-blue-600">
          <div class="flex justify-between items-center mb-2">
            <label class="input-label mb-0">Gemini API Key</label>
            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-blue-600 underline font-bold">Dapatkan Key</a>
          </div>
          <input type="password" id="apiKey" class="custom-input md:w-1/2" placeholder="Tempelkan API Key..." />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Kolom Kiri: Identitas -->
          <div class="glass-card p-6 space-y-4">
            <h3 class="font-bold border-b pb-2 mb-2 text-blue-800 flex items-center gap-2"><i class="fas fa-id-card"></i> Identitas Guru & Sekolah</h3>
            <div><label class="input-label">Nama Sekolah</label><input type="text" id="sekolah" class="custom-input" value="SMPN 1 Manonjaya" /></div>
            <div class="grid grid-cols-2 gap-2">
              <div><label class="input-label">Tahun Pelajaran</label><input type="text" id="tahun" class="custom-input" value="2025/2026" /></div>
              <div>
                <label class="input-label">Semester</label
                ><select id="semester" class="custom-input">
                  <option value="Ganjil">Ganjil</option>
                  <option value="Genap" selected>Genap</option>
                </select>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div><label class="input-label">Nama Guru</label><input type="text" id="guru" class="custom-input" placeholder="Nama Lengkap" /></div>
              <div><label class="input-label">NIP Guru</label><input type="text" id="nipGuru" class="custom-input" placeholder="NIP" /></div>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div><label class="input-label">Kepala Sekolah</label><input type="text" id="kepala" class="custom-input" placeholder="Nama Kepala" /></div>
              <div><label class="input-label">NIP Kepala</label><input type="text" id="nipKepala" class="custom-input" placeholder="NIP" /></div>
            </div>
          </div>

          <!-- Kolom Kanan: Detail Pembelajaran (Kembali ke Input Teks Fleksibel) -->
          <div class="glass-card p-6 space-y-4">
            <h3 class="font-bold border-b pb-2 mb-2 text-emerald-800 flex items-center gap-2"><i class="fas fa-pen-nib"></i> Detail Materi</h3>
            <div class="grid grid-cols-2 gap-2">
              <div><label class="input-label">Mata Pelajaran</label><input type="text" id="mapel" class="custom-input" value="Bahasa Sunda" placeholder="Ketik Mapel..." /></div>
              <div><label class="input-label">Kelas</label><input type="text" id="kelas" class="custom-input" value="VIII" /></div>
            </div>
            <div><label class="input-label">Materi Pokok</label><input type="text" id="materi" class="custom-input" placeholder="Contoh: Menulis Teks Wawaran" /></div>
            <div class="grid grid-cols-2 gap-2">
              <div><label class="input-label">Alokasi Waktu</label><input type="text" id="alokasi" class="custom-input" value="2 JP (80 Menit)" placeholder="Contoh: 2 x 40 Menit" /></div>
              <div>
                <label class="input-label">Model Utama</label>
                <select id="model" class="custom-input">
                  <option value="Problem Based Learning (PBL)">Problem Based Learning (PBL)</option>
                  <option value="Project Based Learning (PjBL)">Project Based Learning (PjBL)</option>
                  <option value="Discovery Learning">Discovery Learning</option>
                  <option value="Inquiry Learning">Inquiry Learning</option>
                </select>
              </div>
            </div>
            <div class="mt-2 flex items-center gap-3 p-3 bg-slate-50 rounded-lg border border-slate-200">
              <input type="checkbox" id="genLKPD" checked class="w-5 h-5 accent-blue-600" />
              <div class="flex flex-col">
                <span class="text-xs font-extrabold text-slate-700">HASILKAN LKPD (LAMPIRAN)</span>
                <span class="text-[10px] text-slate-500">Otomatis di halaman terpisah</span>
              </div>
            </div>
          </div>
        </div>

        <div class="glass-card p-6">
          <label class="input-label">Profil Pelajar Pancasila (P5)</label>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mt-2">
            <label class="p3-checkbox active" onclick="this.classList.toggle('active')"><input type="checkbox" name="p3" value="Beriman & Bertakwa" checked /><span>Beriman & Bertakwa</span></label>
            <label class="p3-checkbox active" onclick="this.classList.toggle('active')"><input type="checkbox" name="p3" value="Bernalar Kritis" checked /><span>Bernalar Kritis</span></label>
            <label class="p3-checkbox active" onclick="this.classList.toggle('active')"><input type="checkbox" name="p3" value="Gotong Royong" checked /><span>Gotong Royong</span></label>
            <label class="p3-checkbox" onclick="this.classList.toggle('active')"><input type="checkbox" name="p3" value="Mandiri" /><span>Mandiri</span></label>
            <label class="p3-checkbox" onclick="this.classList.toggle('active')"><input type="checkbox" name="p3" value="Kreatif" /><span>Kreatif</span></label>
          </div>
        </div>

        <button id="generateBtn" onclick="runGenerator()" class="w-full bg-slate-900 hover:bg-black text-white font-extrabold py-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-3">
          <i class="fas fa-magic text-yellow-400"></i> GENERATE MODUL 8-3-3-4 SEKARANG
        </button>
      </div>

      <div id="resultArea" class="hidden mt-6">
        <div class="no-print flex justify-between mb-4">
          <button onclick="backToEdit()" class="bg-white border px-4 py-2 rounded-lg font-bold text-slate-600 hover:bg-slate-50 transition"><i class="fas fa-chevron-left mr-2"></i> KEMBALI KE FORM</button>
          <button onclick="window.print()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg hover:bg-blue-700 transition"><i class="fas fa-print mr-2"></i> CETAK MODUL AJAR</button>
        </div>
        <div id="rppOutput" class="p-8 md:p-12 border shadow-2xl min-h-screen"></div>
      </div>

      <div id="loader" class="hidden fixed inset-0 bg-white/95 z-50 flex flex-col items-center justify-center text-center">
        <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 font-black text-blue-900 px-4 text-lg">Menganalisis Materi & Merancang 8-3-3-4...</p>
      </div>
    </div>

    <script>
      async function fetchWithRetry(url, options, maxRetries = 5) {
        let lastError;
        for (let i = 0; i < maxRetries; i++) {
          try {
            const response = await fetch(url, options);
            if (response.ok) return await response.json();
          } catch (e) {
            lastError = e;
          }
          await new Promise((res) => setTimeout(res, Math.pow(2, i) * 1000));
        }
        throw lastError || new Error("Koneksi gagal.");
      }

      function cleanAiText(html) {
        // Membersihkan tanda tangan liar yang sering dibuat AI
        const patterns = [
          /Mengetahui,[\s\S]*?NIP\.\s?\d+/gi,
          /Guru Mata Pelajaran[\s\S]*?NIP\.\s?\d+/gi,
          /Kepala Sekolah[\s\S]*?NIP\.\s?\d+/gi,
          /Manonjaya,[\s\S]*?\d{4}/gi,
          /Hormat kami,[\s\S]*?(\d+)?/gi,
          /Tanda Tangan[\s\S]*?_________/gi,
        ];
        let cleaned = html;
        patterns.forEach((p) => (cleaned = cleaned.replace(p, "")));
        return cleaned;
      }

      async function runGenerator() {
        const key = document.getElementById("apiKey").value.trim();
        if (!key) {
          alert("Masukkan API Key!");
          return;
        }

        const p = {
          sekolah: document.getElementById("sekolah").value,
          tahun: document.getElementById("tahun").value,
          semester: document.getElementById("semester").value,
          guru: document.getElementById("guru").value,
          nipGuru: document.getElementById("nipGuru").value,
          kepala: document.getElementById("kepala").value,
          nipKepala: document.getElementById("nipKepala").value,
          mapel: document.getElementById("mapel").value,
          materi: document.getElementById("materi").value,
          kelas: document.getElementById("kelas").value,
          alokasi: document.getElementById("alokasi").value,
          model: document.getElementById("model").value,
          p3: Array.from(document.querySelectorAll('input[name="p3"]:checked'))
            .map((cb) => cb.value)
            .join(", "),
          lkpd: document.getElementById("genLKPD").checked,
        };

        const loader = document.getElementById("loader");
        loader.classList.remove("hidden");

        const systemPrompt = `Anda adalah pakar Kurikulum Merdeka SMP dan Kerangka Deep Learning 8-3-3-4 (Berkesadaran, Bermakna, Menggembirakan).
        
        INSTRUKSI KHUSUS:
        1. Buat Modul Ajar (MA) yang EKSPLISIT menampilkan label: [3M], [3P], dan [4PP].
        2. Sesuaikan Tujuan Pembelajaran (TP) secara logis dengan Alokasi Waktu: ${p.alokasi}. Jangan membuat terlalu banyak TP jika waktu sedikit.
        3. Gunakan Model: ${p.model}.
        4. JANGAN membuat tanda tangan manual apa pun.
        5. Letakkan tag [MODUL_SIG] tepat sebelum bagian LKPD (jika ada).
        6. Berikan instruksi LKPD yang menantang (High Order Thinking Skills).
        7. Format output harus HTML bersih (tabel dan list).`;

        try {
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
          const promptText = `Hasilkan Modul Ajar Deep Learning 8-3-3-4 lengkap dengan LKPD (Jika Diminta: ${p.lkpd}) untuk Materi: ${p.materi}, Mapel: ${p.mapel}.`;

          const data = await fetchWithRetry(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ parts: [{ text: promptText }] }],
              systemInstruction: { parts: [{ text: systemPrompt }] },
            }),
          });

          let aiHtml = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
          aiHtml = aiHtml
            .replace(/```html/gi, "")
            .replace(/```/gi, "")
            .trim();
          aiHtml = cleanAiText(aiHtml);

          const today = new Date();
          const dateStr = `${today.getDate()} ${["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"][today.getMonth()]} ${today.getFullYear()}`;

          const sigArea = `
            <div class="sig-container">
              <table class="sig-table">
                <tr>
                  <td><p>Mengetahui,</p><p>Kepala ${p.sekolah}</p><br><br><br><p><strong><u>${p.kepala || "...................."}</u></strong></p><p>NIP. ${p.nipKepala || "...................."}</p></td>
                  <td><p>Manonjaya, ${dateStr}</p><p>Guru Mata Pelajaran,</p><br><br><br><p><strong><u>${p.guru || "...................."}</u></strong></p><p>NIP. ${p.nipGuru || "...................."}</p></td>
                </tr>
              </table>
            </div>`;

          const header = `
            <div style="text-align:center; margin-bottom:15px; border-bottom: 3px double black; padding-bottom: 10px;">
              <h1 style="font-size:15pt; margin:0; font-weight: bold;">MODUL AJAR DEEP LEARNING (8-3-3-4)</h1>
              <h2 style="font-size:13pt; margin:0;">${p.sekolah.toUpperCase()} - TP ${p.tahun}</h2>
            </div>
            <table style="width:100% !important; margin-bottom: 20px;">
              <tr><td width="20%" class="section-bg">Mata Pelajaran</td><td width="30%">${p.mapel}</td><td width="20%" class="section-bg">Kelas / Smtr</td><td width="30%">${p.kelas} / ${p.semester}</td></tr>
              <tr><td class="section-bg">Materi Pokok</td><td colspan="3"><strong>${p.materi}</strong></td></tr>
              <tr><td class="section-bg">Alokasi Waktu</td><td>${p.alokasi}</td><td class="section-bg">Model Utama</td><td>${p.model}</td></tr>
              <tr><td class="section-bg">Profil Pancasila</td><td colspan="3">${p.p3}</td></tr>
              <tr><td class="section-bg">Kerangka Kerja</td><td colspan="3">8-3-3-4 (BBM - 3P - 4PP - 8 Standar Mutu)</td></tr>
            </table>`;

          const pageDivider = `<div class="page-divider"></div>`;
          let finalContent = "";

          // Mencari posisi pemisah
          if (aiHtml.includes("[MODUL_SIG]")) {
            finalContent = aiHtml.replace("[MODUL_SIG]", sigArea + (p.lkpd ? pageDivider : ""));
          } else {
            // Fallback: cari kata kunci LKPD atau Lembar Kerja
            const searchIndex = aiHtml.toLowerCase().indexOf("lembar kerja");
            if (searchIndex !== -1 && p.lkpd) {
              finalContent = aiHtml.substring(0, searchIndex) + sigArea + pageDivider + aiHtml.substring(searchIndex);
            } else {
              finalContent = aiHtml + sigArea;
            }
          }

          document.getElementById("rppOutput").innerHTML = header + finalContent;
          if (window.MathJax) await window.MathJax.typesetPromise([document.getElementById("rppOutput")]);

          document.getElementById("inputForm").classList.add("hidden");
          document.getElementById("resultArea").classList.remove("hidden");
          window.scrollTo(0, 0);
        } catch (err) {
          alert("Error: " + err.message);
        } finally {
          loader.classList.add("hidden");
        }
      }

      function backToEdit() {
        document.getElementById("resultArea").classList.add("hidden");
        document.getElementById("inputForm").classList.remove("hidden");
      }
    </script>
  </body>
</html>

